<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live StreamHub</title>
  
  <style>
    body { margin: 0; background: black; color: white; font-family: sans-serif; overflow: hidden; }
    /* CSS untuk IFRAME agar tampil full-screen */
    #liveIframe { 
      width: 100vw; 
      height: 100vh; 
      position: fixed; 
      top: 0; 
      left: 0; 
      border: none; /* Hapus border iframe */
    }
    #chatBox {
      position: fixed; bottom: 70px; left: 10px; right: 10px;
      max-height: 40vh; overflow-y: auto; font-size: 14px;
      background: rgba(0,0,0,0.3); border-radius: 10px; padding: 8px;
      z-index: 10;
    }
    #chatInput {
      position: fixed; bottom: 10px; left: 10px; right: 10px;
      display: flex; gap: 5px;
      z-index: 10;
    }
    #chatInput input {
      flex: 1; padding: 8px; border-radius: 5px; border: none;
    }
    #chatInput button {
      padding: 8px 10px; border: none; border-radius: 5px;
      background: #ff006e; color: white;
      cursor: pointer;
    }
    #viewersBox {
      position: fixed; top: 10px; right: 10px;
      background: rgba(0,0,0,0.4); padding: 5px 10px; border-radius: 15px;
      font-size: 14px;
      z-index: 10;
    }
  </style>
</head>
<body>
  <iframe 
    id="liveIframe" 
    src="https://vdo.ninja/?scene=0&room=testinglivestrram" 
    allow="camera; microphone; fullscreen; display-capture"
  ></iframe>
  
  <div id="viewersBox">ðŸ‘¤ <span id="viewersCount">0</span> penonton</div>
  <div id="chatBox"></div>
  <div id="chatInput">
    <input id="chatText" placeholder="Ketik komentar..." />
    <button id="sendChatButton">Kirim</button>
  </div>
  
  <script type="module">
    // 1. Import fungsi Firebase Modular
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, onChildAdded, onDisconnect, set } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";
    
    // 2. Konfigurasi Firebase 
    const firebaseConfig = {
      apiKey: "AIzaSyAoJBClnMsyRFKeXsqG9oauypjWAo9wQEw",
      authDomain: "livestreamhub-28db2.firebaseapp.com",
      databaseURL: "https://livestreamhub-28db2-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "livestreamhub-28db2",
      storageBucket: "livestreamhub-28db2.firebasestorage.app",
      messagingSenderId: "317541196121",
      appId: "1:317541196121:web:3501340de1f078b1fdec48",
      measurementId: "G-XBLK7QW6GC"
    };

    // 3. Inisialisasi Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- VARIABEL & REFERENSI DOM ---
    const chatBox = document.getElementById("chatBox");
    const chatText = document.getElementById("chatText");
    const sendChatButton = document.getElementById("sendChatButton");
    const viewersCountElement = document.getElementById("viewersCount");
    
    let username = localStorage.getItem("username");
    
    // 4.1. Login penonton
    if (!username) {
      username = prompt("Masukkan nama Anda:");
      if (!username || username.trim() === "") username = "Tamu Anonim (" + Math.floor(Math.random() * 100) + ")"; 
      localStorage.setItem("username", username);
    }
    
    // 4.2. Membersihkan data penonton lama
    function cleanViewersOnLoad() {
        const viewersRef = ref(db, "viewers");
        // Hapus seluruh node 'viewers'
        return set(viewersRef, null); // Mengembalikan Promise dari operasi set
    }

    // --- 4.3. KELOLA PENONTON SETELAH PEMBERSIHAN ---
    
    // ðŸ’¡ PERBAIKAN: Seluruh logika penonton diletakkan di dalam .then()
    cleanViewersOnLoad()
      .then(() => {
        console.log("Data penonton lama berhasil dibersihkan. Memulai sesi baru...");

        const viewersRef = ref(db, "viewers");
        
        // Tambahkan penonton saat ini (ANDA)
        const newViewerRef = push(viewersRef, { name: username });
        
        const viewerKey = newViewerRef.key;
        const viewerRefToRemove = ref(db, `viewers/${viewerKey}`);

        // Set onDisconnect untuk menghapus node saat user keluar
        onDisconnect(viewerRefToRemove).remove();
        
        // Hitung jumlah penonton real-time
        onValue(viewersRef, (snapshot) => {
          const data = snapshot.val();
          // Menghitung jumlah objek anak dalam data
          const count = data ? Object.keys(data).length : 0;
          viewersCountElement.innerText = count;
        });
      })
      .catch((error) => {
          console.error("Gagal membersihkan data penonton lama atau memulai sesi:", error);
      });
      

    // 4.4. Tampilkan Chat (Chat tidak memerlukan urutan ketat seperti penonton)
    const chatRef = ref(db, "chat");
    onChildAdded(chatRef, (data) => {
      const msg = data.val();
      const el = document.createElement("div");
      
      const nameSpan = document.createElement("span");
      nameSpan.textContent = msg.name;
      nameSpan.style.fontWeight = "bold";
      nameSpan.style.color = (msg.name === username) ? "#FFD700" : "#FF006E";

      el.appendChild(nameSpan);
      el.innerHTML += ": " + msg.text;
      
      chatBox.appendChild(el);
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    // 4.5. Kirim Chat
    function sendChat() {
      const text = chatText.value.trim();
      if (!text) return;
      
      push(chatRef, { name: username, text }); 
      chatText.value = "";
    }
    
    // --- 5. EVENT LISTENERS ---
    
    // Pasang listener pada tombol
    sendChatButton.addEventListener('click', sendChat);
    
    // Pasang listener pada input field untuk mengirim chat dengan tombol Enter
    chatText.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendChat();
      }
    });

  </script>
</body>
</html>

